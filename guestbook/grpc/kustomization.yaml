resources:
- ../base/
patchesStrategicMerge:
- |-
    apiVersion: v1
    kind: Service
    metadata:
      labels:
        run: haproxy-ingress
      name: haproxy-ingress
    spec:
      type: NodePort
      ports:
      - name: port-1
        port: 8080
        protocol: TCP
        targetPort: 8080
        nodePort: 30080
      - name: port-2
        port: 8443
        protocol: TCP
        targetPort: 8443
        nodePort: 30443
      - name: port-3
        port: 1936
        protocol: TCP
        targetPort: 1936
        nodePort: 31936
      selector:
        run: haproxy-ingress
    ---
    kind: ConfigMap
    apiVersion: v1
    data:
      backend-protocol: h2
      tls-alpn: h2,http/1.1
      use-htx: "true"
      dynamic-scaling: "true"
      backend-server-slots-increment: "4"
      http-port: "8080"
      https-port: "8443"
      stats-port: "1936"
    metadata:
      name: haproxy-configmap
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: haproxy-ingress-clusterrole
    rules:
      - apiGroups:
          - ""
        resources:
          - configmaps
          - endpoints
          - nodes
          - pods
          - secrets
        verbs:
          - list
          - watch
      - apiGroups:
          - ""
        resources:
          - nodes
        verbs:
          - get
      - apiGroups:
          - ""
        resources:
          - services
        verbs:
          - get
          - list
          - watch
      - apiGroups:
          - extensions
          - networking.k8s.io
        resources:
          - ingressclasses
          - ingresses
        verbs:
          - get
          - list
          - watch
      - apiGroups:
          - ""
        resources:
          - events
        verbs:
          - create
          - patch
      - apiGroups:
          - extensions
          - networking.k8s.io
        resources:
          - ingresses/status
        verbs:
          - update
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: haproxy-ingress-clusterrole-nisa-binding
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: haproxy-ingress-clusterrole
    subjects:
      - kind: ServiceAccount
      name: haproxy-ingress-serviceaccount